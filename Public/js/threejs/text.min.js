
ICEMAN3D.Text=function(){this.scene=null;this.camera=null;this.renderer=null;this.ambientLight=null;this.directionalLight=null;this.canvas=null;this.cameraMove=null;this.navigation=null;this.settings=null;this.drawLoop=null;this.enableDraw=null;this.scaleGaodu=3;this.scaleSize=10;this.plane=null;this.mainMesh=null;this.planeSize=100};ICEMAN3D.Text.prototype.InitSettings=function(a){this.settings={cameraEyePosition:new ICEMAN3D.Coord(1,1,1),cameraCenterPosition:new ICEMAN3D.Coord(0,0,0),cameraUpVector:new ICEMAN3D.Coord(0,0,1),lightAmbientColor:[0.5,0.5,0.5],lightDiffuseColor:[0.5,0.5,0.5]};if(a!==undefined){if(a.cameraEyePosition!==undefined){this.settings.cameraEyePosition=ICEMAN3D.CoordFromArray(a.cameraEyePosition)}if(a.cameraCenterPosition!==undefined){this.settings.cameraCenterPosition=ICEMAN3D.CoordFromArray(a.cameraCenterPosition)}if(a.cameraUpVector!==undefined){this.settings.cameraUpVector=ICEMAN3D.CoordFromArray(a.cameraUpVector)}if(a.lightAmbientColor!==undefined){this.settings.lightAmbientColor=a.lightAmbientColor}if(a.lightDiffuseColor!==undefined){this.settings.lightDiffuseColor=a.lightDiffuseColor}}return true};ICEMAN3D.Text.prototype.Start=function(b,e){if(!ICEMAN3D.IsWebGLEnabled()){return false}if(!this.InitSettings(e)){return false}if(!this.InitThree(b)){return false}if(!this.InitCamera(e)){return false}if(!this.InitLights()){return false}this.size=this.planeSize/2;var f=5;var g=new THREE.Geometry();for(var c=-this.size;c<=this.size;c+=f){g.vertices.push(new THREE.Vector3(-this.size,c,0));g.vertices.push(new THREE.Vector3(this.size,c,0));g.vertices.push(new THREE.Vector3(c,-this.size,0));g.vertices.push(new THREE.Vector3(c,this.size,0))}var d=new THREE.LineBasicMaterial({color:0,opacity:0.2,transparent:true});var a=new THREE.Line(g,d,THREE.LinePieces);var g=new THREE.PlaneBufferGeometry(this.planeSize,this.planeSize);this.plane=new THREE.Mesh(g);this.plane.visible=false;this.scene.add(this.plane);this.drawLoop=false;this.enableDraw=true;this.DrawIfNeeded();return true};ICEMAN3D.Text.prototype.InitThree=function(a){this.canvas=a;if(!this.canvas||!this.canvas.getContext){return false}this.scene=new THREE.Scene();if(!this.scene){return false}var b={canvas:this.canvas,antialias:true,preserveDrawingBuffer:true};this.renderer=new THREE.WebGLRenderer(b);this.renderer.setPixelRatio(window.devicePixelRatio);if(!this.renderer){return false}this.renderer.setClearColor(new THREE.Color(16777215));this.renderer.setSize(this.canvas.width,this.canvas.height);return true};ICEMAN3D.Text.prototype.InitCamera=function(a){this.cameraMove=new ICEMAN3D.Camera(ICEMAN3D.CoordFromArray(a.cameraEyePosition),ICEMAN3D.CoordFromArray(a.cameraCenterPosition),ICEMAN3D.CoordFromArray(a.cameraUpVector),a.fieldOfView,a.nearClippingPlane,a.farClippingPlane);if(!this.cameraMove){return false}this.navigation=new ICEMAN3D.Navigation();if(!this.navigation.Init(this.canvas,this.cameraMove,this.DrawIfNeeded.bind(this),this.Resize.bind(this))){return false}this.camera=new THREE.PerspectiveCamera(this.cameraMove.fieldOfView,this.canvas.width/this.canvas.height,this.cameraMove.nearClippingPlane,this.cameraMove.farClippingPlane);if(!this.camera){return false}this.scene.add(this.camera);return true};ICEMAN3D.Text.prototype.InitLights=function(){var b=new THREE.Color();var c=new THREE.Color();b.setRGB(this.settings.lightAmbientColor[0],this.settings.lightAmbientColor[1],this.settings.lightAmbientColor[2]);c.setRGB(this.settings.lightDiffuseColor[0],this.settings.lightDiffuseColor[1],this.settings.lightDiffuseColor[2]);this.ambientLight=new THREE.AmbientLight(b.getHex());if(!this.ambientLight){return false}this.scene.add(this.ambientLight);this.directionalLight=new THREE.DirectionalLight(c.getHex());if(!this.directionalLight){return false}var a=new THREE.Vector3().subVectors(this.cameraMove.eye,this.cameraMove.center);this.directionalLight.position.set(a.x,a.y,a.z);this.scene.add(this.directionalLight);return true};ICEMAN3D.Text.prototype.Resize=function(){this.camera.aspect=this.canvas.width/this.canvas.height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.canvas.width,this.canvas.height);this.DrawIfNeeded()};ICEMAN3D.Text.prototype.EnableDraw=function(a){this.enableDraw=a};ICEMAN3D.Text.prototype.Draw=function(){if(!this.enableDraw){return}this.camera.position.set(this.cameraMove.eye.x,this.cameraMove.eye.y,this.cameraMove.eye.z);this.camera.up.set(this.cameraMove.up.x,this.cameraMove.up.y,this.cameraMove.up.z);this.camera.lookAt(new THREE.Vector3(this.cameraMove.center.x,this.cameraMove.center.y,this.cameraMove.center.z));var a=new THREE.Vector3().subVectors(this.cameraMove.eye,this.cameraMove.center);this.directionalLight.position.set(a.x,a.y,a.z);this.renderer.render(this.scene,this.camera);if(this.drawLoop){setStyle(this.Draw.bind(this))}};ICEMAN3D.Text.prototype.DrawIfNeeded=function(){if(!this.drawLoop){this.Draw()}};ICEMAN3D.Text.prototype.VertexCount=function(){var a=0;this.scene.traverse(function(b){if(b instanceof THREE.Mesh&&b.name=="meshText"){if(b.geometry instanceof THREE.Geometry){a=a+b.geometry.vertices.length}}});return a};$(function(){var o=3;var l;var a;var g,e,h,k,l;var f;var j=300;function m(){a=document.getElementById("container");h=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});h.setClearColor(15790320);h.setPixelRatio(window.devicePixelRatio);h.setSize($(a).width(),$(a).height());a.appendChild(h.domElement);g=new THREE.PerspectiveCamera(40,$(a).width()/$(a).height(),1,10000);g.position.set(0,-100,180);g.up.x=0;g.up.y=0;g.up.z=1;g.lookAt(new THREE.Vector3());k=new THREE.OrbitControls(g,h.domElement);k.target=new THREE.Vector3(0,0,0);k.noPan=false;k.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};k.update();e=new THREE.Scene();var w=j/2,p=5;var v=new THREE.Geometry();for(var q=-w;q<=w;q+=p){v.vertices.push(new THREE.Vector3(-w,q,0));v.vertices.push(new THREE.Vector3(w,q,0));v.vertices.push(new THREE.Vector3(q,-w,0));v.vertices.push(new THREE.Vector3(q,w,0))}var u=new THREE.LineBasicMaterial({color:0,opacity:0.2,transparent:true});var x=new THREE.Line(v,u,THREE.LinePieces);e.add(x);var v=new THREE.PlaneBufferGeometry(j,j);f=new THREE.Mesh(v);f.visible=false;e.add(f);var t=new THREE.SpotLight(16777215,0.3,0);t.position.set(-700,1000,1000);t.castShadow=false;e.add(t);var r=[];var s=new THREE.PointLight(16777215,0.6,0);s.position.set(-700,1000,100);e.add(s);r.push(s);s=new THREE.PointLight(16777215,0.6,0);s.position.set(200,-1000,0);e.add(s);r.push(s);s=new THREE.PointLight(16777215,0.7,0);s.position.set(3200,-3900,3500);e.add(s);r.push(s);s=new THREE.PointLight(16777215,0.6,0);s.position.set(0,0,-10000);e.add(s);r.push(s);s=new THREE.PointLight(16777215,0.6,0);s.position.set(0,0,10000);e.add(s);r.push(s);window.addEventListener("resize",i,false)}function i(){g.aspect=$(a).width()/$(a).height();g.updateProjectionMatrix();h.setSize($(a).width(),$(a).height())}function c(){h.render(e,g)}function b(){requestAnimationFrame(b);c()}function d(){var p=new THREE.Vector3();var r=new THREE.Matrix3();var q="";q+="solid exported\n";e.traverse(function(v){if(v instanceof THREE.Mesh&&v.name=="photoTo3D"){var A=v.geometry;var s=v.matrixWorld;if(A instanceof THREE.Geometry){var y=A.vertices;var t=A.faces;r.getNormalMatrix(s);for(var x=0,u=t.length;x<u;x++){var z=t[x];p.copy(z.normal).applyMatrix3(r).normalize();q+="\tfacet normal "+p.x+" "+p.y+" "+p.z+"\n";q+="\t\touter loop\n";var B=[z.a,z.b,z.c];for(var w=0;w<3;w++){p.copy(y[B[w]]).applyMatrix4(s);q+="\t\t\tvertex "+p.x+" "+p.y+" "+p.z+"\n"}q+="\t\tendloop\n";q+="\tendfacet\n"}}}});q+="endsolid exported\n";return q}function n(){var p=new THREE.Vector3();var t=new THREE.Matrix3();var u=0;e.traverse(function(w){if(w instanceof THREE.Mesh&&w.name=="photoTo3D"){if(w.geometry instanceof THREE.Geometry){u+=w.geometry.faces.length}}});var v=80;var s=u*2+u*3*4*4+80+4;var r=new ArrayBuffer(s);var q=new DataView(r);q.setUint32(v,u,true);v+=4;e.traverse(function(z){if(!(z instanceof THREE.Mesh)){return}if(!(z.geometry instanceof THREE.Geometry)){return}if(z.name!="photoTo3D"){return}var E=z.geometry;var w=z.matrixWorld;var C=E.vertices;var x=E.faces;t.getNormalMatrix(w);for(var B=0,y=x.length;B<y;B++){var D=x[B];p.copy(D.normal).applyMatrix3(t).normalize();q.setFloat32(v,p.x,true);v+=4;q.setFloat32(v,p.y,true);v+=4;q.setFloat32(v,p.z,true);v+=4;var F=[D.a,D.b,D.c];for(var A=0;A<3;A++){p.copy(C[F[A]]).applyMatrix4(w);q.setFloat32(v,p.x,true);v+=4;q.setFloat32(v,p.y,true);v+=4;q.setFloat32(v,p.z,true);v+=4}q.setUint16(v,0,true);v+=2}});return q}});