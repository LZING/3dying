
var cancelList=new Array();var cancelIndex=0;var canvasWidth=800;var canvasHeight=600;$(function(){var a=document.getElementById("main-nav").offsetHeight;canvasWidth=$(".canvas_container").width();canvasHeight=window.innerHeight-a-90;initCanvas();initDrag();size=$("#line_size button.selected").data("value");$(document).on("click",".pencil",function(){draw_graph("pencil",this)});$(document).on("click",".handwriting",function(){draw_graph("handwriting",this)});$(document).on("click",".showLine",function(){showLineSize(this)});$(document).on("click",".rubber",function(){draw_graph("rubber",this)});$(document).on("click",".drawLine",function(){draw_graph("line",this)});$(document).on("click",".square",function(){draw_graph("square",this)});$(document).on("click",".circle",function(){draw_graph("circle",this)});$(document).on("click",".fill",function(){fill(this)});$(document).on("click",".cancel",function(){cancel(this)});$(document).on("click",".next",function(){next(this)});$(document).on("click",".clearContext",function(){clearContext("1");context.fillStyle="white";preview()});$(document).on("click",".downloadImage",function(){downloadImage()});$(".draw_controller li:first").click();$(".line_size button").click(function(){size=$(this).data("value");$("#line_size").hide()});$(".line").hover(function(){showLineSize($(this)[0])},function(){var b=setTimeout(function(){$(".line_size").fadeOut(200)},100);$(".line_size").hover(function(){$(".line_size").show();clearTimeout(b)},function(){$(".line_size").fadeOut(200)})})});var initCanvas=function(){$(".canvas_container").width(canvasWidth);$(".canvas_container").height(canvasHeight);canvas=document.getElementById("canvas");canvas.width=canvasWidth;canvas.height=canvasHeight;context=canvas.getContext("2d");canvasTop=$(canvas).offset().top;canvasLeft=$(canvas).offset().left;canvas_bak=document.getElementById("canvas_bak");canvas_bak.width=canvasWidth;canvas_bak.height=canvasHeight;context_bak=canvas_bak.getContext("2d")};var downloadImage=function(){$("#downloadImage_a")[0].href=canvas.toDataURL()};var showLineSize=function(c){if($("#line_size").is(":hidden")){var b=50;var a=$(c).offset().left-10;$("#line_size")[0].style.left=a+"px";$("#line_size")[0].style.top=b+"px";$("#line_size").show()}else{$("#line_size").hide()}};var chooseLineSize=function(a){size=a;$("#line_size").hide()};var fill=function(){context.fillStyle=color;context_bak.fillStyle=color;var c=$("#canvas"),a=c.width(),b=c.height();context.fillRect(0,0,a,b);var d=new Image();d.src=canvas_bak.toDataURL();context.drawImage(d,0,0,d.width,d.height,0,0,canvasWidth,canvasHeight);clearContext();saveImageToAry()};var cancel=function(){if(cancelList.length<=cancelIndex){return}cancelIndex++;context.clearRect(0,0,canvasWidth,canvasHeight);var c=new Image();var b=cancelList.length-1-cancelIndex;var a=cancelList[b];if(a){c.src=a;c.onload=function(){context.drawImage(c,0,0,c.width,c.height,0,0,canvasWidth,canvasHeight);preview()}}else{preview()}};var next=function(){if(cancelIndex<=0){return}cancelIndex--;context.clearRect(0,0,canvasWidth,canvasHeight);var c=new Image();var b=cancelList.length-1-cancelIndex;var a=cancelList[b];if(a){c.src=a;c.onload=function(){context.drawImage(c,0,0,c.width,c.height,0,0,canvasWidth,canvasHeight);preview()}}else{preview()}};var rubberFinish=function(){preview()};var saveImageToAry=function(){cancelIndex=0;var a=canvas.toDataURL();cancelList.push(a);preview()};function handleDragOver(a){a.stopPropagation();a.preventDefault()}function isImage(a){switch(a){case"image/jpeg":case"image/png":case"image/gif":case"image/bmp":case"image/jpg":return true;default:return false}}function handleFileSelect(a){a.stopPropagation();a.preventDefault();var d=a.dataTransfer.files;for(var c=0,e;e=d[c];c++){var b=e.type?e.type:"n/a";reader=new FileReader();isImg=isImage(b);if(isImg){reader.onload=(function(f){return function(n){var g=new Image();g.src=n.target.result;var j;var r;var i=0;var s=0;var p=canvasWidth/2;var q=canvasHeight/2;var k=1;var o=g.width;var m=g.height;r=p/o;j=q/m;if(r<1||j<1){k=(r<=j?r:j)}if(k<1){o=o*k;m=m*k}i=(p-o)/2;s=(q-m)/2;g.onload=function(){context.drawImage(g,0,0,g.width,g.height,i,s,o,m)}}})(e);reader.readAsDataURL(e)}}}var initDrag=function(){var a=document.getElementById("canvas_bak");a.addEventListener("dragover",handleDragOver,false);a.addEventListener("drop",handleFileSelect,false)};var mainMesh,scene;var planeSize=150;function renderPhoto(){Potrace.process(function(){var e=Potrace.getPolygons(1,8);var t=0;var s=0;var h=new ClipperLib.Clipper();h.AddPaths(e,ClipperLib.PolyType.ptSubject,true);h.AddPaths([[]],ClipperLib.PolyType.ptClip,true);var k=new ClipperLib.PolyTree();h.Execute(ClipperLib.PolyFillType.ctUnion,k,ClipperLib.PolyFillType.pftEvenOdd,ClipperLib.PolyFillType.pftNonZero);var w=ClipperLib.JS.PolyTreeToExPolygons(k);console.log("make mesh");var y=1;var a=3;var z={amount:a/y,bevelEnabled:false,bevelSegments:2,steps:2,bevelSize:1,bevelThickness:1};var p=0;var n=0;var r=0;var l=new THREE.Geometry();for(p=0;p<w.length;p++){var d=new THREE.Shape();d.moveTo(w[p].outer[0].X-t,w[p].outer[0].Y-s);for(n=1;n<w[p].outer.length;n++){d.lineTo(w[p].outer[n].X-t,w[p].outer[n].Y-s)}d.lineTo(w[p].outer[0].X-t,w[p].outer[0].Y-s);for(n=0;n<w[p].holes.length;n++){var f=new THREE.Path();f.moveTo(w[p].holes[n][0].X-t,w[p].holes[n][0].Y-s);for(r=1;r<w[p].holes[n].length;r++){f.lineTo(w[p].holes[n][r].X-t,w[p].holes[n][r].Y-s)}f.lineTo(w[p].holes[n][0].X-t,w[p].holes[n][0].Y-s);d.holes.push(f)}var g=new THREE.ExtrudeGeometry(d,z);l.merge(g)}l.center();var m=new THREE.Matrix4();var c=new THREE.Matrix4();var b=new THREE.Matrix4();c.makeRotationY(Math.PI);b.makeRotationZ(Math.PI);m.multiplyMatrices(c,b);m.multiplyScalar(y);l.applyMatrix(m);if(mainMesh){scene.remove(mainMesh)}mainMesh=new THREE.Mesh(l,new THREE.MeshPhongMaterial({color:1482885,specular:24704,shading:THREE.SmoothShading,shininess:10,fog:false,side:THREE.DoubleSide}));mainMesh.name="meshDraw";scene.add(mainMesh);var x=$("#gaodu").text();var v=Math.abs(mainMesh.geometry.boundingBox.max.z-mainMesh.geometry.boundingBox.min.z);mainMesh.scale.z=1*x/v;var q=Math.abs(mainMesh.geometry.boundingBox.max.x-mainMesh.geometry.boundingBox.min.x);var o=Math.abs(mainMesh.geometry.boundingBox.max.y-mainMesh.geometry.boundingBox.min.y);var u=Math.max(q,o);if(u>planeSize){mainMesh.scale.x=mainMesh.scale.y=planeSize/u}mainMesh.position.z=v*mainMesh.scale.z/2})}var gaodu=3;var container;var camera,renderer,controls;var plane,header,height;function init(){header=document.getElementById("main-nav").offsetHeight;height=window.innerHeight-header-90;container=document.getElementById("container");renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});renderer.setClearColor(15790320);renderer.setPixelRatio(window.devicePixelRatio);renderer.setSize($(container).width(),height);container.appendChild(renderer.domElement);camera=new THREE.PerspectiveCamera(40,$(container).width()/height,1,10000);camera.position.set(0,-100,180);camera.up.x=0;camera.up.y=0;camera.up.z=1;camera.lookAt(new THREE.Vector3());controls=new THREE.OrbitControls(camera,renderer.domElement);controls.target=new THREE.Vector3(0,0,0);controls.noPan=false;controls.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};controls.update();scene=new THREE.Scene();var h=planeSize/2,a=5;var g=new THREE.Geometry();for(var b=-h;b<=h;b+=a){g.vertices.push(new THREE.Vector3(-h,b,0));g.vertices.push(new THREE.Vector3(h,b,0));g.vertices.push(new THREE.Vector3(b,-h,0));g.vertices.push(new THREE.Vector3(b,h,0))}var f=new THREE.LineBasicMaterial({color:0,opacity:0.2,transparent:true});var j=new THREE.Line(g,f,THREE.LinePieces);scene.add(j);var g=new THREE.PlaneBufferGeometry(planeSize,planeSize);plane=new THREE.Mesh(g);plane.visible=false;scene.add(plane);var e=new THREE.SpotLight(16777215,0.3,0);e.position.set(-700,1000,1000);e.castShadow=false;scene.add(e);var c=[];var d=new THREE.PointLight(16777215,0.6,0);d.position.set(-700,1000,100);scene.add(d);c.push(d);d=new THREE.PointLight(16777215,0.6,0);d.position.set(200,-1000,0);scene.add(d);c.push(d);d=new THREE.PointLight(16777215,0.7,0);d.position.set(3200,-3900,3500);scene.add(d);c.push(d);d=new THREE.PointLight(16777215,0.6,0);d.position.set(0,0,-10000);scene.add(d);c.push(d);d=new THREE.PointLight(16777215,0.6,0);d.position.set(0,0,10000);scene.add(d);c.push(d);window.addEventListener("resize",onWindowResize,false)}function onWindowResize(){camera.aspect=$(container).width()/height;camera.updateProjectionMatrix();renderer.setSize($(container).width(),height)}function render(){renderer.render(scene,camera)}function animate(){requestAnimationFrame(animate);render()}function preview(){Potrace.loadImageFromUrl(document.getElementById("canvas").toDataURL());Potrace.setParameter({turnpolicy:"majority",turdsize:4,optcurve:true,alphamax:1,opttolerance:0.2,bmgray:127});renderPhoto();onWindowResize()}$(function(){init();animate();var e=$("#slider_height");if(e.length>0){e.slider({min:1,max:140,value:3,orientation:"horizontal",range:"min",step:1,slide:function(g,h){if(!mainMesh){return}gaodu=h.value;$("#gaodu").text(gaodu);mainMesh.geometry.computeBoundingBox();var f=Math.abs(mainMesh.geometry.boundingBox.max.z-mainMesh.geometry.boundingBox.min.z);mainMesh.scale.z=1*gaodu/f;mainMesh.position.z=f*mainMesh.scale.z/2}})}$(document).on("click","#preview",function(){preview()}).on("click","#saveAndPrintBtn",function(){var j=new FormData();var m="手绘线条";j.append("name",m);var f=renderer.domElement.toDataURL("image/png").split(",");var l=atob(f[1]);var g=new Uint8Array(l.length);for(var h=0;h<l.length;h++){g[h]=l.charCodeAt(h)}j.append("image",new Blob([g],{type:"image/png"}),m+".png");j.append("stl",new Blob([b()],{type:"text/plain"}),m+".stl");var k=new XMLHttpRequest();k.open("POST",$(this).data("url"),true);k.setRequestHeader("X-Requested-With","XMLHttpRequest");k.upload.onprogress=function(n){var i=0;i=100*n.loaded/n.total;console.log(i+"%")};k.upload.onloadend=function(i){console.log("onloadend=>")};k.onload=function(n){if(this.status==200&&this.responseText>0){location.href='/apps/print#'+this.responseText;}else{alert(this.responseText)}};k.upload.onerror=function(i,n){console.log(i,n);alert(i+n)};k.send(j);return false}).on("click","#exportStl",function(){if(mainMesh){d()}else{alert("请绘制图案");return false}});function a(){window.open(renderer.domElement.toDataURL("image/png"),"mywindow");return false}function c(){var f=new THREE.Vector3();var h=new THREE.Matrix3();var g="";g+="solid exported\n";scene.traverse(function(o){if(o instanceof THREE.Mesh&&o.name=="meshDraw"){var t=o.geometry;var k=o.matrixWorld;if(t instanceof THREE.Geometry){var r=t.vertices;var m=t.faces;h.getNormalMatrix(k);for(var q=0,n=m.length;q<n;q++){var s=m[q];f.copy(s.normal).applyMatrix3(h).normalize();g+="\tfacet normal "+f.x+" "+f.y+" "+f.z+"\n";g+="\t\touter loop\n";var u=[s.a,s.b,s.c];for(var p=0;p<3;p++){f.copy(r[u[p]]).applyMatrix4(k);g+="\t\t\tvertex "+f.x+" "+f.y+" "+f.z+"\n"}g+="\t\tendloop\n";g+="\tendfacet\n"}}}});g+="endsolid exported\n";return g}function b(){var f=new THREE.Vector3();var j=new THREE.Matrix3();var k=0;scene.traverse(function(m){if(m instanceof THREE.Mesh&&m.name=="meshDraw"){if(m.geometry instanceof THREE.Geometry){k+=m.geometry.faces.length}}});var l=80;var i=k*2+k*3*4*4+80+4;var h=new ArrayBuffer(i);var g=new DataView(h);g.setUint32(l,k,true);l+=4;scene.traverse(function(p){if(!(p instanceof THREE.Mesh)){return}if(!(p.geometry instanceof THREE.Geometry)){return}if(p.name!="meshDraw"){return}var u=p.geometry;var m=p.matrixWorld;var s=u.vertices;var n=u.faces;j.getNormalMatrix(m);for(var r=0,o=n.length;r<o;r++){var t=n[r];f.copy(t.normal).applyMatrix3(j).normalize();g.setFloat32(l,f.x,true);l+=4;g.setFloat32(l,f.y,true);l+=4;g.setFloat32(l,f.z,true);l+=4;var v=[t.a,t.b,t.c];for(var q=0;q<3;q++){f.copy(s[v[q]]).applyMatrix4(m);g.setFloat32(l,f.x,true);l+=4;g.setFloat32(l,f.y,true);l+=4;g.setFloat32(l,f.z,true);l+=4}g.setUint16(l,0,true);l+=2}});return g}function d(h){var g=c();var f;try{f=new Blob([g],{type:"text/plain"})}catch(i){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(window.BlobBuilder){var j=new BlobBuilder();j.append(g);f=j.getBlob("text/plain")}}saveAs(f,"手绘图案.stl")}});